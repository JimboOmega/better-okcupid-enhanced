<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="core.js"></script>
<script type="text/javascript">
(function(){
	
	var fetch_cache = {};
	
	var requestHandler = function(request, sender, sendResponse) {
		var response = { type: request.type };
		switch ( request.type ) {
			
			case "db.clear":
				core.db.clear(request.key);
				break;
				
			case "db.get":
				response.key = request.key;
				response.value = core.db.get(request.key);
				break;
				
			case "db.get.all":
				var data = {};
				for ( k in localStorage ) {
					data[k] = localStorage[k];
				}
				response.data = data;
				break;
			
			case "db.set":
				core.db.set(request.key, request.value);
				break;
			
			case "fetch":
				var url = request.url,
					key = url.toLowerCase(),
					entry = fetch_cache[key],
					age = request.age || 60*60*1000,
					timestamp = (new Date()).getTime();
				if ( request.force || !entry || !entry.data || !entry.timestamp || entry.timestamp + age < timestamp ) {
					request.type = request.requestType || "GET";
					request.key = key;
					request.success = function(data, status, jqXHR) {
						fetch_cache[this.key] = {
							data: data,
							timestamp: (new Date()).getTime()
						};
						response.data = data;
						sendResponse(response);
					}
					request.error = function(jqXHR, status, message) {
						response.error = message;
						sendResponse(response);
					}
					$.ajax(request);
					return;
				} else {
					response.cached = true;
					response.data = entry.data;
				}
				break;
		}
		
		sendResponse(response);
	};
	
	chrome.extension.onRequest.addListener(requestHandler);
	
	chrome.browserAction.onClicked.addListener(function(tab) {
		window.open("http://www.okcupid.com")
	})
	/*
	chrome.browserAction.setPopup({popup:"popup.html"})
	setTimeout(function() {
		chrome.browserAction.setPopup({popup:""})
	}, 1000)
	chrome.browserAction.setBadgeBackgroundColor({color:[255,255,255,100]})
	chrome.browserAction.setBadgeText({text:"1"})
	//*/
})();
</script>