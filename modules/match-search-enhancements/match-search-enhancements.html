<script>
(function(module) {
    if(window.location.pathname.match(/profile/g) != null)
    {
        var username = $('#basic_info_sn').text()

        var profiles = module.db.get("profiles") || {}
        var this_user = profiles[username] || {}
        if(typeof this_user.visits == 'undefined')
        {
            this_user.visits = 1
        }
        else
        {
            this_user.visits += 1
        }
        this_user.last_visited = new Date()
        profiles[username] = this_user
        module.db.set("profiles", profiles)
    }
    if(window.location.pathname.match(/match/g) != null)
    {
        var profiles = module.db.get("profiles") || {}
        //should I pre-load all the db values here so I don't have to get them in the loop?

        var check_match = function(index, match_row){
            var dom_id = match_row.id
            var match_name = dom_id.substring(4)

            if(module.db.get("low_match_hide"))
            {
                percentage_string = $(match_row).find(".percentage").first().text()
                number_string = percentage_string.substring(0,percentage_string.length - 1)
                if(number_string < module.db.get("low_match_limit"))
                {
                    $(match_row).hide()
                }

            }
            if(typeof profiles[match_name] != "undefined")
            {
                if(module.db.get("already_visited_highlight") && typeof profiles[match_name].visits  != "undefined"  && profiles[match_name].visits > 0)
                {
                    $("#"+dom_id).css('background-color', 'red')
                    $("#"+dom_id).children().css('background-color', 'red')
                }
                //assumption - if user object exists, they must have been at least seen before
                else if(module.db.get("already_seen_highlight")){
                    $("#"+dom_id).css('background-color', 'yellow')
                    $("#"+dom_id).children().css('background-color', 'yellow')
                }
            }
            var this_user = profiles[match_name] || {}
            this_user.last_seen = new Date()
            if(typeof this_user.first_seen == 'undefined')
            {
                this_user.first_seen = new Date()
            }
            profiles[match_name] = this_user
        }
        //check matches already on page
        $('.match_row').each(check_match)
        module.db.set("profiles", profiles)

        MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation){
            if(mutation.addedNodes.length > 0 &&$(mutation.addedNodes).hasClass("match_row"))
            {
                check_match(0,mutation.addedNodes[0])
            }
            })
            //update profiles database only after processing all nodes
            module.db.set("profiles", profiles)
        })
        // configuration of the observer (may be unecessary)
        var config = { attributes: true, childList: true, characterData: true }
        observer.observe($('#match_results')[0], config);

    }
})(module);
</script>