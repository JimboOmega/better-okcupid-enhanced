<script>
(function(module) {
    if(window.location.pathname.match(/profile/g) != null)
    {
        var username = $('#basic_info_sn').text()

        var profiles = module.db.get("profiles") || {}
        var this_user = profiles[username] || {}
        if(typeof this_user.visits == 'undefined')
        {
            this_user.visits = 1
        }
        else
        {
            this_user.visits += 1
        }
        this_user.last_visited = new Date()
        profiles[username] = this_user
        module.db.set("profiles", profiles)
    }
    if(window.location.pathname.match(/match/g) != null)
    {
        //don't update the already seen object on the dom inserted event
        //otherwise all the profiles already on the page will get marked
        //instead, keep this copy out of scope

        var profiles_on_load = module.db.get("profiles") || {}
        var check_match = function(index, match_row){
            var dom_id = match_row.id
            var match_name = dom_id.substring(4)

            if(module.db.get("low_match_hide"))
            {
                percentage_string = $(match_row).find(".percentage").first().text()
                number_string = percentage_string.substring(0,percentage_string.length - 1)
                if(number_string < module.db.get("low_match_limit"))
                {
                    $(match_row).hide()
                }

            }
            if(typeof profiles_on_load[match_name] != "undefined")
            {
                if(module.db.get("already_visited_highlight") && typeof profiles_on_load[match_name].visits  != "undefined"  && profiles_on_load[match_name].visits > 0)

                {
                    $("#"+dom_id).css('background-color', 'red')
                    $("#"+dom_id).children().css('background-color', 'red')
                }
                else if(module.db.get("already_seen_highlight")){
                $("#"+dom_id).css('background-color', 'yellow')
                $("#"+dom_id).children().css('background-color', 'yellow')
                }
            }
            //todo: getting and setting this on each match may be slow; instead, link to loads
            var profiles = module.db.get("profiles") || {}
            var this_user = profiles[match_name] || {}
            this_user.last_seen = new Date()
            profiles[match_name] = this_user
            module.db.set("profiles", profiles)

        }


        $('.match_row').each(check_match)
        MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation){
            if(mutation.addedNodes.length > 0 &&$(mutation.addedNodes).hasClass("match_row"))
            {
                check_match(0,mutation.addedNodes[0])
            }
            })

        })
        // configuration of the observer:
        var config = { attributes: true, childList: true, characterData: true }

// pass in the target node, as well as the observer options
        observer.observe($('#match_results')[0], config);

    }
})(module);
</script>